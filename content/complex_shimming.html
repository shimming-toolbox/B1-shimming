
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Complex \(B_1^+\) shimming &#8212; B1+ shimming in MRI</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Phase-only \(B_1^+\) shimming" href="phase_only.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/shimming_toolbox_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">B1+ shimming in MRI</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b1_mapping.html">
   Mapping the
   <span class="math notranslate nohighlight">
    \(B_1^+\)
   </span>
   field
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="single_transmit.html">
   Single transmit excitation (sTx)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="circular_polarization.html">
   Circular polarization (CP mode)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="phase_only.html">
   Phase-only
   <span class="math notranslate nohighlight">
    \(B_1^+\)
   </span>
   shimming
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Complex
   <span class="math notranslate nohighlight">
    \(B_1^+\)
   </span>
   shimming
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/content/complex_shimming.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/shimming-toolbox/B1-shimming/master?urlpath=tree/book/content/complex_shimming.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optimizing-the-phase-and-magnitude-of-the-shim-weights">
   Optimizing the phase and magnitude of the shim weights
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#roi-size-and-local-b-1-shimming">
   ROI size and local
   <span class="math notranslate nohighlight">
    \(B_1^+\)
   </span>
   shimming
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#energy-deposition-and-sar-constraint">
   Energy deposition and SAR constraint
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#global-sar">
     Global SAR
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#local-sar">
     Local SAR
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sar-and-ultra-high-field-imaging">
     SAR and Ultra High Field imaging
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#virtual-observation-points">
     Virtual observation points
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#targeting-a-specific-b-1-value">
   Targeting a specific
   <span class="math notranslate nohighlight">
    \(B_1^+\)
   </span>
   value
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#further-improving-the-b-1-homogeneity">
   Further improving the
   <span class="math notranslate nohighlight">
    \(B_1^+\)
   </span>
   homogeneity
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-post-processing">
     Data post processing
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pulse-design">
     Pulse design
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calibration-free-methods">
     Calibration-free methods
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Complex B_1^+ shimming</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optimizing-the-phase-and-magnitude-of-the-shim-weights">
   Optimizing the phase and magnitude of the shim weights
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#roi-size-and-local-b-1-shimming">
   ROI size and local
   <span class="math notranslate nohighlight">
    \(B_1^+\)
   </span>
   shimming
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#energy-deposition-and-sar-constraint">
   Energy deposition and SAR constraint
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#global-sar">
     Global SAR
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#local-sar">
     Local SAR
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sar-and-ultra-high-field-imaging">
     SAR and Ultra High Field imaging
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#virtual-observation-points">
     Virtual observation points
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#targeting-a-specific-b-1-value">
   Targeting a specific
   <span class="math notranslate nohighlight">
    \(B_1^+\)
   </span>
   value
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#further-improving-the-b-1-homogeneity">
   Further improving the
   <span class="math notranslate nohighlight">
    \(B_1^+\)
   </span>
   homogeneity
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-post-processing">
     Data post processing
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pulse-design">
     Pulse design
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calibration-free-methods">
     Calibration-free methods
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="complex-b-1-shimming">
<h1>Complex <span class="math notranslate nohighlight">\(B_1^+\)</span> shimming<a class="headerlink" href="#complex-b-1-shimming" title="Permalink to this headline">¶</a></h1>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import all python libraries and functions used in this notebook</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">scipy</span>

<span class="kn">from</span> <span class="nn">functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">variation</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="optimizing-the-phase-and-magnitude-of-the-shim-weights">
<h2>Optimizing the phase and magnitude of the shim weights<a class="headerlink" href="#optimizing-the-phase-and-magnitude-of-the-shim-weights" title="Permalink to this headline">¶</a></h2>
<p>In the previous section (phase-only shimming), we demonstrated how optimizing the phase of the shim weights can improve the <span class="math notranslate nohighlight">\(B_1^+\)</span> homogeneity. In this section we investigate what happens if we optimize both the <em>phase</em> and the <em>magnitude</em> values of the shim weights, thus adding more degrees of freedom to the optimization process.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because Scipy optimization algorithms do not handle complex variables, the shim weights phases and magnitudes are reshaped into an vector of length <span class="math notranslate nohighlight">\(2 \times N_{Tx}\)</span> over which the optimization is performed.</p>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the data</span>
<span class="n">b1_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;./data/b1_maps.npy&#39;</span><span class="p">)</span>  <span class="c1"># Complex 2D B1 maps of each element (x, y, n_coils)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_Tx</span> <span class="o">=</span> <span class="n">b1_maps</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># Number of transmit elements</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">b1_maps</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>

<span class="c1"># Single pulse excitation</span>
<span class="n">weights_sTx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">b1_sTx</span> <span class="o">=</span> <span class="p">(</span><span class="n">b1_maps</span> <span class="o">@</span> <span class="n">weights_sTx</span><span class="p">)</span>

<span class="c1"># CP mode</span>
<span class="n">weights_CP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">n_Tx</span><span class="p">),</span> <span class="n">n_Tx</span><span class="p">))</span> <span class="c1"># CP weights</span>
<span class="n">b1_CP</span> <span class="o">=</span> <span class="n">b1_maps</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">n_Tx</span><span class="p">),</span> <span class="n">n_Tx</span><span class="p">))</span>

<span class="c1"># Phase-only shimming </span>
<span class="n">weights_PO</span> <span class="o">=</span> <span class="n">phase_only_shimming</span><span class="p">(</span><span class="n">b1_maps</span><span class="p">)</span>
<span class="n">b1_PO</span> <span class="o">=</span> <span class="n">b1_maps</span> <span class="o">@</span> <span class="n">weights_PO</span>

<span class="n">initial_weights</span> <span class="o">=</span> <span class="n">weights_PO</span>  <span class="c1"># Starting from phase-only shim weights</span>
<span class="n">b1_roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">b1_maps</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="p">[</span><span class="n">b1_maps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">b1_maps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">8</span><span class="p">])</span>
<span class="n">b1_roi</span> <span class="o">=</span> <span class="n">b1_roi</span><span class="p">[</span><span class="n">b1_roi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

<span class="k">def</span> <span class="nf">cost_function</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">variation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_roi</span> <span class="o">@</span> <span class="n">vector_to_complex</span><span class="p">(</span><span class="n">weights</span><span class="p">)))</span>

<span class="n">weights_PM</span> <span class="o">=</span> <span class="n">vector_to_complex</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">cost_function</span><span class="p">,</span> <span class="n">complex_to_vector</span><span class="p">(</span><span class="n">initial_weights</span><span class="p">))</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="n">b1_PM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_maps</span> <span class="o">@</span> <span class="n">weights_PM</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<span class="n">vmax</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">b1_CP</span><span class="p">,</span> <span class="n">b1_PO</span><span class="p">,</span> <span class="n">b1_PM</span><span class="p">))))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_CP</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$|B_1^+|$ (CP mode)</span><span class="se">\n</span><span class="s2">CoV = </span><span class="si">{</span><span class="n">variation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_CP</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_PO</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$|B_1^+|$ (phase-only)</span><span class="se">\n</span><span class="s2">CoV = </span><span class="si">{</span><span class="n">variation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_PO</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_PM</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$|B_1^+|$ (phase + magnitude)</span><span class="se">\n</span><span class="s2">CoV = </span><span class="si">{</span><span class="n">variation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_PM</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.72</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;nT/V&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/complex_shimming_3_0.png" src="../_images/complex_shimming_3_0.png" />
</div>
</div>
<p>We observe that by optimizing both the phase and the magnitude of the excitation pulses, we obtain a lower CoV than in the “phase-only” case. This method is usually referred to as <strong>Static <span class="math notranslate nohighlight">\(B_1^+\)</span> shimming</strong> (or <strong>Static RF shimming</strong> ).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Once again, this process might result in sub-optimal solutions if initial optimization values are not wisely chosen. There are even more local minima here due to the higher number of degrees of freedom.</p>
<p>In the example above, the complex optimization uses the phase-only shim weights as a starting point to make sure that the final <span class="math notranslate nohighlight">\(B_1^+\)</span> homogeneity is improved compared to the phase-only shimming scenario.</p>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">17</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Complex shim weights&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
<span class="n">show_weights</span><span class="p">(</span><span class="n">weights_CP</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;CP mode&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
<span class="n">show_weights</span><span class="p">(</span><span class="n">weights_PO</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Phase-only&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
<span class="n">show_weights</span><span class="p">(</span><span class="n">weights_PM</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Magnitude + phase&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/complex_shimming_5_0.png" src="../_images/complex_shimming_5_0.png" />
</div>
</div>
<p>The additionnal degrees of freedom are illustrated by the fact that the shim weights are no more constrained to the unit circle but can have any magnitude value.</p>
</div>
<div class="section" id="roi-size-and-local-b-1-shimming">
<h2>ROI size and local <span class="math notranslate nohighlight">\(B_1^+\)</span> shimming<a class="headerlink" href="#roi-size-and-local-b-1-shimming" title="Permalink to this headline">¶</a></h2>
<p>On the previous example, we see that there might still be some local drops or hotspots of the <span class="math notranslate nohighlight">\(B_1^+\)</span> field after shimming. This is mainly due to the fact that there is usually no solution that yields a perfectly homogeneous <span class="math notranslate nohighlight">\(B_1^+\)</span> field, because we are limited by the number of transmit elements and their respective <span class="math notranslate nohighlight">\(B_1^+\)</span> distributions.</p>
<p>In the particular cases where we only want to image a specific region of interest (ROI) in the body (e.g. the spinal cord, the prostate), performing <span class="math notranslate nohighlight">\(B_1^+\)</span> shimming over this ROI usually results in better homogeneity.</p>
<p>However, the homogeneity outside of the ROI might be greatly affected by this solution, this method is thus particularly suited when we need a very homogeneous field in a small region but we don’t mind degrading the rest of the image.</p>
<p>Running <span class="math notranslate nohighlight">\(B_1^+\)</span> shimming over a small ROI is illustrated below:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask_reduced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">b1_maps</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">mask_reduced</span><span class="p">[</span><span class="n">x</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">10</span><span class="p">:</span><span class="n">x</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">10</span><span class="p">:</span><span class="n">y</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">b1_roi_reduced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">b1_maps</span> <span class="o">*</span> <span class="n">mask_reduced</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_Tx</span><span class="p">])</span>
<span class="n">b1_roi_reduced</span> <span class="o">=</span> <span class="n">b1_roi_reduced</span><span class="p">[</span><span class="n">b1_roi_reduced</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

<span class="k">def</span> <span class="nf">cost_function</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">variation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_roi_reduced</span> <span class="o">@</span> <span class="n">vector_to_complex</span><span class="p">(</span><span class="n">weights</span><span class="p">)))</span>

<span class="n">weights_PM_masked</span> <span class="o">=</span> <span class="n">vector_to_complex</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">cost_function</span><span class="p">,</span> <span class="n">complex_to_vector</span><span class="p">(</span><span class="n">initial_weights</span><span class="p">))</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="n">b1_PM_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_maps</span> <span class="o">@</span> <span class="n">weights_PM_masked</span><span class="p">)</span>

<span class="n">b1_PM_ROI</span> <span class="o">=</span> <span class="n">b1_PM</span> <span class="o">*</span> <span class="n">mask_reduced</span>
<span class="n">b1_PM_ROI</span><span class="p">[</span><span class="n">b1_PM_ROI</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="n">b1_PM_masked_ROI</span> <span class="o">=</span> <span class="n">b1_PM_masked</span> <span class="o">*</span> <span class="n">mask_reduced</span>
<span class="n">b1_PM_masked_ROI</span><span class="p">[</span><span class="n">b1_PM_masked_ROI</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span>
<span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">b1_PM_ROI</span><span class="p">,</span> <span class="n">b1_PM_masked_ROI</span><span class="p">)))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">b1_PM</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">b1_PM_ROI</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;|$B_1^+$| (phase + magnitude)</span><span class="se">\n</span><span class="s2">CoV in ROI: </span><span class="si">{</span><span class="n">variation</span><span class="p">(</span><span class="n">b1_PM</span><span class="p">[</span><span class="n">mask_reduced</span><span class="o">!=</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;CoV outside ROI: </span><span class="si">{</span><span class="n">variation</span><span class="p">(</span><span class="n">b1_PM</span><span class="p">[</span><span class="n">mask</span><span class="o">-</span><span class="n">mask_reduced</span><span class="o">!=</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">b1_PM_masked</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">b1_PM_masked_ROI</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;|$B_1^+$| (reduced ROI)</span><span class="se">\n</span><span class="s2">CoV in ROI: </span><span class="si">{</span><span class="n">variation</span><span class="p">(</span><span class="n">b1_PM_masked</span><span class="p">[</span><span class="n">mask_reduced</span><span class="o">!=</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;CoV outside ROI: </span><span class="si">{</span><span class="n">variation</span><span class="p">(</span><span class="n">b1_PM_masked</span><span class="p">[</span><span class="n">mask</span><span class="o">-</span><span class="n">mask_reduced</span><span class="o">!=</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;nT/V&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/complex_shimming_8_0.png" src="../_images/complex_shimming_8_0.png" />
</div>
</div>
<p>We indeed observe that <span class="math notranslate nohighlight">\(B_1^+\)</span> field is more homogeneous over the chosen ROI (square in the middle of the brain). As expected, the homogeneity outside of the ROI is greatly decreased as these voxels are not considered during the optimization process.</p>
</div>
<div class="section" id="energy-deposition-and-sar-constraint">
<h2>Energy deposition and SAR constraint<a class="headerlink" href="#energy-deposition-and-sar-constraint" title="Permalink to this headline">¶</a></h2>
<p>As we saw earlier, performing RF-shimming modifies the current sent to each transmit element and might result in RF “hotspots”. When applying an RF electromagnetic field to a patient, its electric component induces heat dissipation in the tissues, wich might be dangerous if the temperature rise becomes too important.</p>
<p>In order to perfom MRI scans safely, we thus limit the energy deposition in the patient. This is done by monitoring the <strong>Specific Absorbtion Rate (SAR)</strong>, which corresponds to the rate at which the energy is absorbed per unit mass of tissue. This is the same metric that the one used to monitoring the RF emissions of mobile phones, and it is usually expressed in watts per kilogram (W/kg).</p>
<p>As of today, no perfectly accurate method has been developped in order to measure the SAR during in-vivo MR experiments. For this reason, SAR estimations are based on sophisticated modeling of the coil/body system.</p>
<p>In MRI, the SAR is computed globally and locally, using the following formula:</p>
<div class="math notranslate nohighlight">
\[
  SAR = w^HQw
\]</div>
<p>Where <span class="math notranslate nohighlight">\(w\)</span> is a complex vector of length <span class="math notranslate nohighlight">\(C\)</span> (shim weights) and <span class="math notranslate nohighlight">\(Q\)</span> is a matrix of size <span class="math notranslate nohighlight">\((C\times C)\)</span> where C is the number of transmit channels. <span class="math notranslate nohighlight">\(Q\)</span> is determined through EM simulations, based on each channel’s electric field distribution.</p>
<p>As <span class="math notranslate nohighlight">\(Q\)</span> does not correspond to in-vivo measurements, a safety factor is usually applied in order to safely consider the differences between the simulated and actual experiments.</p>
<div class="section" id="global-sar">
<h3>Global SAR<a class="headerlink" href="#global-sar" title="Permalink to this headline">¶</a></h3>
<p>The global SAR is the total power absorbed by the whole body divided by the weight of the whole
body. It is limited to 2W/kg by the IEC standard 60601-2-33. It is usually measured by the scanner during the scan, and pulse sequences are interrupted if the limit value is exceded.</p>
</div>
<div class="section" id="local-sar">
<h3>Local SAR<a class="headerlink" href="#local-sar" title="Permalink to this headline">¶</a></h3>
<p>The local SAR aims to limit the energy deposition in small portions of the body. During the simulation process, a Q matrix will be computed for every 10g of tissues and the limit value will be larger than for global shimming (tyically 10W/kg for the head and trunk, and 20W/kg for the extremities), in order to take the existence of local SAR hotspots into account.</p>
</div>
<div class="section" id="sar-and-ultra-high-field-imaging">
<h3>SAR and Ultra High Field imaging<a class="headerlink" href="#sar-and-ultra-high-field-imaging" title="Permalink to this headline">¶</a></h3>
<p>SAR is proportional to <span class="math notranslate nohighlight">\(\omega_0^2\)</span>, meaning that the energy deposition at 7T is ~5 times higher than at 3T. SAR constraints will thus become even more challenging at UHF in order to ensure patient’s safety. Local SAR will be particularly constraining as the arising of SAR hotspots becomes frequent due to the use of several Tx elements positioned close to the patient.</p>
</div>
<div class="section" id="virtual-observation-points">
<h3>Virtual observation points<a class="headerlink" href="#virtual-observation-points" title="Permalink to this headline">¶</a></h3>
<p>Virtual Observation Points (VOP) are matrices used to reduce the number of Q-matrices considered during the optimization process. The principle is that the Q-matrices corresponding to all the 10g tissues are gathered in different subgroups (VOP) based on their similarities. The larger the subgroup, the less VOPs will be used for optimization, thereby accelerating the optimization process.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If we want a very small number of VOPs, we have to increase the subgroup size, i.e., reduce the accuracy of the SAR computation. This might result in SAR overestimations and overconstrained optimizations (sacrificing homogeneity for lower SAR).</p>
</div>
<p>Let’s compare the <span class="math notranslate nohighlight">\(B_1^+\)</span> distribution obtained whith an unconstrained vs. constrained SAR shim weight optimization:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Virtual observation points are stored in a .npy file</span>
<span class="n">vop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;./data/vop.npy&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">max_SAR</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">vop</span><span class="p">):</span>
    <span class="c1"># computes max local SAR</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vop</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">weights</span><span class="p">)))</span>

<span class="n">SAR_limit</span> <span class="o">=</span> <span class="n">max_SAR</span><span class="p">(</span><span class="n">weights_CP</span><span class="p">,</span> <span class="n">vop</span><span class="p">)</span> 

<span class="n">initial_weights</span> <span class="o">=</span> <span class="n">complex_to_vector</span><span class="p">(</span><span class="n">weights_PO</span><span class="p">)</span>

<span class="n">b1_roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">b1_maps</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_Tx</span><span class="p">])</span>
<span class="n">b1_roi</span> <span class="o">=</span> <span class="n">b1_roi</span><span class="p">[</span><span class="n">b1_roi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

<span class="k">def</span> <span class="nf">cost_function</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">variation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_roi</span> <span class="o">@</span> <span class="n">vector_to_complex</span><span class="p">(</span><span class="n">weights</span><span class="p">)))</span>

<span class="n">cons</span> <span class="o">=</span> <span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>  <span class="o">-</span><span class="n">max_SAR</span><span class="p">(</span><span class="n">vector_to_complex</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">vop</span><span class="p">)</span> <span class="o">+</span> <span class="n">SAR_limit</span><span class="p">})</span> <span class="c1"># SAR constraint</span>

<span class="n">weights_SAR</span> <span class="o">=</span> <span class="n">vector_to_complex</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">cost_function</span><span class="p">,</span> <span class="n">initial_weights</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="n">b1_SAR</span> <span class="o">=</span> <span class="n">b1_maps</span> <span class="o">@</span> <span class="n">weights_SAR</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">b1_PM</span><span class="p">,</span> <span class="n">b1_SAR</span><span class="p">)))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_PM</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;|$B_1^+$| (phase + magnitude)</span><span class="se">\n</span><span class="s2">CoV in ROI: </span><span class="si">{</span><span class="n">variation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_PM</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="sa">f</span><span class="s2">&quot;Mean: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_PM</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> nT/V</span><span class="se">\n</span><span class="s2">Max local SAR: </span><span class="si">{</span><span class="n">SAR_limit</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> a.u.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

<span class="n">im</span> <span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_SAR</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;|$B_1^+$| (SAR constrained)</span><span class="se">\n</span><span class="s2">CoV in ROI: </span><span class="si">{</span><span class="n">variation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_SAR</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="sa">f</span><span class="s2">&quot;Mean: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_SAR</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> nT/V</span><span class="se">\n</span><span class="s2">Max local SAR: </span><span class="si">{</span><span class="n">max_SAR</span><span class="p">(</span><span class="n">weights_SAR</span><span class="p">,</span> <span class="n">vop</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> a.u.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;nT/V&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/complex_shimming_11_0.png" src="../_images/complex_shimming_11_0.png" />
</div>
</div>
<p>Here we managed to get the same homogeneity (as assessed by the CoV) in the SAR-unconstrained and SAR-constrained  scenario. However, we observe a decrease in the mean <span class="math notranslate nohighlight">\(B_1^+\)</span> values, because the optimization process has reduced the shim weights magnitudes in order not to exceed the maximum local SAR of the CP mode.</p>
</div>
</div>
<div class="section" id="targeting-a-specific-b-1-value">
<h2>Targeting a specific <span class="math notranslate nohighlight">\(B_1^+\)</span> value<a class="headerlink" href="#targeting-a-specific-b-1-value" title="Permalink to this headline">¶</a></h2>
<p>An infinity of cost functions can be used to fulfill different goals during the optimization process.</p>
<p>In this section, instead of trying to minimize the coefficient of variation, the goal is to minimize the difference between the combined <span class="math notranslate nohighlight">\(B_1^+\)</span> and a target value (here 60 nT/V) by using the following cost function:</p>
<div class="math notranslate nohighlight">
\[\large cost function = \sum_n^{N_{voxels}}(|B_{1n}^+| - target)^2\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the target value is too high to be reached without exceeding the SAR limit, the maximum reachable mean <span class="math notranslate nohighlight">\(B_1^+\)</span> value will be obtained, while preserving a fairly good homogeneity.</p>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># B1+ value to target in nT/V</span>
<span class="n">target</span> <span class="o">=</span> <span class="mi">60</span>

<span class="k">def</span> <span class="nf">cost_function_MLS</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
    <span class="n">b1_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_roi</span> <span class="o">@</span> <span class="n">vector_to_complex</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">b1_abs</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">weights_MLS</span> <span class="o">=</span> <span class="n">vector_to_complex</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">cost_function_MLS</span><span class="p">,</span> <span class="n">initial_weights</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="n">b1_MLS</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_maps</span> <span class="o">@</span> <span class="n">weights_MLS</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">17</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">b1_MLS</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$|B_1^+|$ (MLS optimization)</span><span class="se">\n</span><span class="s2"> Mean value: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">b1_MLS</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (target: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;nT/V&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/complex_shimming_14_0.png" src="../_images/complex_shimming_14_0.png" />
</div>
</div>
</div>
<div class="section" id="further-improving-the-b-1-homogeneity">
<h2>Further improving the <span class="math notranslate nohighlight">\(B_1^+\)</span> homogeneity<a class="headerlink" href="#further-improving-the-b-1-homogeneity" title="Permalink to this headline">¶</a></h2>
<div class="section" id="data-post-processing">
<h3>Data post processing<a class="headerlink" href="#data-post-processing" title="Permalink to this headline">¶</a></h3>
<p>In order to reduce the influence of the <span class="math notranslate nohighlight">\(B_1^+\)</span> inhomogeneity on the final image we can perform offline image post-processing (segmentation, filtering, normalization, etc.). These methods usually require knowledge of the <span class="math notranslate nohighlight">\(B_1+\)</span> distribution (which can be measured or estimated from the image intensity) and cannot be used to improve the image contrast or SNR.</p>
<p>[1] Cohen et al. 2000. “Rapid and Effective Correction of RF Inhomogeneity for High Field Magnetic Resonance Imaging.”</p>
<p>[2] Wang et al. 2005. “Measurement and Correction of Transmitter and Receiver Induced Nonuniformities in Vivo.”</p>
</div>
<div class="section" id="pulse-design">
<h3>Pulse design<a class="headerlink" href="#pulse-design" title="Permalink to this headline">¶</a></h3>
<p>In order to get even more homogeneous <span class="math notranslate nohighlight">\(B_1^+\)</span> distributions, researchers have been playing with pulse design solution (sending different pulse shape on each Tx elements, depositing energy at strategic k-space locations, etc.). Pulse design is very interesting when coupled to pTx capabilities as it provides state-of-the-art <span class="math notranslate nohighlight">\(B_1^+\)</span> homogenizations, but this method requires extensive knowledge of the pulse design theory and is computationally demanding.</p>
<p>[3] Saekho et al. 2006. “Fast-Kz Three-Dimensional Tailored Radiofrequency Pulse for Reduced B1 Inhomogeneity.”</p>
</div>
<div class="section" id="calibration-free-methods">
<h3>Calibration-free methods<a class="headerlink" href="#calibration-free-methods" title="Permalink to this headline">¶</a></h3>
<p>Some homogenization methods do not require any time consuming mapping or optimization steps and are referred to as calibration-free. Among them, Universal Pulses are obtained by optimizing pulses over a set of subject to correct for the <span class="math notranslate nohighlight">\(B_1^+\)</span> inhomogeneities in all subsequent scanned subjects. Even if these solutions are not patient-specific, very promising results have been demonstrated in the brain, surpassing static <span class="math notranslate nohighlight">\(B_1^+\)</span> shimming.</p>
<p>[4] Gras  et al. 2017. “Universal Pulses: A New Concept for Calibration‐free Parallel Transmission.”</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="phase_only.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Phase-only <span class="math notranslate nohighlight">\(B_1^+\)</span> shimming</p>
        </div>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Gaspard Cereza<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>